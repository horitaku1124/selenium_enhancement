<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">
<title>Side convert</title>

<style>
#side, #new_side {
    width: 100%;
    height: 400px;
    box-sizing: border-box;
}

article {
    display: flex;
}
section.input_box, section.output_box {
    width: 100%;
}
</style>
<script>
const puppeteerBase = `
const puppeteer = require('puppeteer');

const baseUrl = '__URL__';

const textMatch = function(expected, actual) {
    if (expected !== actual) {
        console.warn("Text not match", expected, actual);
    }
};

(async () => {
    const browser = await puppeteer.launch({
        args: [
            '--no-sandbox',
            '--disable-setuid-sandbox'
        ],
        headless: false
    });
    const page = await browser.newPage();

    __SCRIPTS__

    console.log(page.length);
    browser.close();
})();
`;
const seleniumBase = `
import org.junit.Test;
import org.junit.After;
import org.junit.Before;
import static org.junit.Assert.assertEquals;
import org.openqa.selenium.By;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.firefox.FirefoxDriver;

public class __CLASS_NAME__ {
    private static final String BASE_URL = "__URL__";

    private WebElement findAnyElement(WebDriver driver, By[] targets) {
        for(By target: targets) {
            WebElement element = driver.findElement(target);
            if (element != null) {
                return element;
            }
        }
        return null;
    }

    private WebDriver driver;
    @Before
    public void before() {
        System.setProperty("webdriver.gecko.driver", "./geckodriver");
        driver = new FirefoxDriver();
    }
    @After
    public void after() {
        driver.quit();
    }

    @Test
    public void test1() {
        String verifyText = "";
        By[] targets = null;

__SCRIPTS__

    }
}

`;

document.addEventListener('DOMContentLoaded', () => {
    let putUniqueId = document.getElementById('putUniqueId');
    let convertToPuppeteer = document.getElementById('convertToPuppeteer');
    let convertToSelenium = document.getElementById('convertToSelenium');
    putUniqueId.addEventListener('click', () => {
        let text = document.getElementById('side').value;
        let side = JSON.parse(text);
        console.log(side);
        console.log(side.tests);
        for (let i = 0;i < side.tests.length;i++) {
            const partA = "00000000-0000-0000-" + (i.toString().padStart(4, '0'));
            for (let j = 0;j < side.tests[i].commands.length;j++) {
                let partB = partA + "-" + (j.toString().padStart(12, '0'));
                side.tests[i].commands[j].id = partB;
            }
        }
        document.getElementById('new_side').value = JSON.stringify(side);
    });
    convertToPuppeteer.addEventListener('click', () => {
        let text = document.getElementById('side').value;
        let side = JSON.parse(text);
        let newSide = puppeteerBase;
        newSide = newSide.replace(/__URL__/, side.url);

        let scripts = "";
        for (let i = 0;i < side.tests.length;i++) {
            for (let j = 0;j < side.tests[i].commands.length;j++) {
                const cmd = side.tests[i].commands[j];
                if (cmd.command === "clickAt") {
                    let target = cmd.target;
                    let match = target.match(/^id=(\S+)/);
                    if (match) {
                        target = "#" + match[1];
                    }
                    scripts += "\t" + "await page.click('" + target + "');" + "\n";
                }
                if (cmd.command === "open") {
                    let target = cmd.target;
                    scripts += "\t" + "await page.goto(baseUrl + \'" + target + "\');" + "\n";
                }
                if (cmd.command === "type") {
                    let target = cmd.target;
                    let match = target.match(/^id=(\S+)/);
                    if (match) {
                        target = "#" + match[1];
                    }
                    scripts += "\t" + "await page.type('" + target + "', '" + cmd.value + "\');" + "\n";
                }
                if (cmd.command === "verifyText") {
                    let target = cmd.target;
                    let xml = `
                    let text = await page.evaluate(() => {
        const xpath = "${target}";
        return document.evaluate(xpath, document, null, XPathResult.FIRST_ORDERED_NODE_TYPE, null).singleNodeValue.innerText;
    });\n`;
                    xml += "textMatch(text, '" + cmd.value + "');";
                    scripts += xml;
                }
            }
        }
        newSide = newSide.replace(/__SCRIPTS__/, scripts);

        document.getElementById('new_side').value = newSide;
    });
    convertToSelenium.addEventListener('click', () => {
        let text = document.getElementById('side').value;
        let className = document.getElementById('class_name').value;
        let side = JSON.parse(text);
        let newSide = seleniumBase;
        newSide = newSide.replace(/__URL__/, side.url);
        newSide = newSide.replace(/__CLASS_NAME__/, className);

        let targetDecision = (target, targetList) => {
            let targetPart = "";
            target = target.replace(/"/g, "\\\"");
            if (target) {
                let match = target.match(/^xpath=(\S+)/);
                let match2 = target.match(/^css=(.+)/);
                let match3 = target.match(/^id=(\S+)/);
                let match4 = target.match(/^name=(\S+)/);
                if (match) {
                    targetPart += "By.xpath(\"" + match[1] + "\"),";
                } else if (match2) {
                    targetPart += "By.cssSelector(\"" + match2[1] + "\"),";
                } else if (match3) {
                    targetPart += "By.id(\"" + match3[1] + "\"),";
                } else if (match4) {
                    targetPart += "By.cssSelector(\"name=" + match4[1] + "\"),";
                }
            }
            targetPart += "\n";
            for (let targetPair of targetList) {
                let target = targetPair[0];
                let kind = targetPair[1];
                target = target.replace(/"/g, "\\\"");
                let match = target.match(/^xpath=(\S+)/);
                let match2 = target.match(/^css=(.+)/);
                let match3 = target.match(/^id=(\S+)/);
                let match4 = target.match(/^name=(\S+)/);
                if (match && kind === "xpath:idRelative") {
                    target = "By.xpath(\"" + match[1] + "\")";
                } else if (match2 && kind === "css:finder") {
                    target = "By.cssSelector(\"" + match2[1] + "\")";
                } else if (match3) {
                    target = "By.id(\"" + match3[1] + "\")";
                } else if (match4) {
                    target = "By.cssSelector(\"name=" + match4[1] + "\")";
                } else {
                    continue;
                }
                targetPart += target + ",\n";
            }
            return targetPart;
        };

        let scripts = "";
        let indent = "";
        for (let i = 0;i < side.tests.length;i++) {
            for (let j = 0;j < side.tests[i].commands.length;j++) {
                indent = "        ";
                const cmd = side.tests[i].commands[j];
                if (cmd.command === "click" || cmd.command === "clickAt") {
                    let targetPart = targetDecision(cmd.target, cmd.targets);
                    scripts += `
                    targets = new By[]{
                        ${targetPart}
                    };
                    findAnyElement(driver, targets).click();\n`;
                }
                if (cmd.command === "open") {
                    let target = cmd.target;
                    scripts += indent + "driver.get(BASE_URL + \"" + target + "\");" + "\n";
                }
                // if (cmd.command === "type") {
                //     let target = cmd.target;
                //     let match = target.match(/^id=(\S+)/);
                //     if (match) {
                //         target = "#" + match[1];
                //     }
                //     scripts += "\t" + "await page.type('" + target + "', '" + cmd.value + "\');" + "\n";
                // }
                if (cmd.command === "verifyText") {
                    let targetPart = targetDecision(cmd.target, cmd.targets);
                    scripts += `
                    targets = new By[]{
                        ${targetPart}
                    };

                    verifyText = findAnyElement(driver, targets).getText();
                    assertEquals(verifyText, "${cmd.value}");\n`;
                }
            }
        }
        newSide = newSide.replace(/__SCRIPTS__/, scripts);

        document.getElementById('new_side').value = newSide;
    });
});
</script>
</head>
<body>
    <article>
        <section class="input_box">
            <textarea id="side" ></textarea>
        </section>
        <section>
            <button id="putUniqueId">Unique ID</button><br/><br/>
            <input type="text" id="class_name" value="SeleniumTest">
            <button id="convertToPuppeteer">To Puppeteer</button><br/>
            <button id="convertToSelenium">To Selenium</button><br/>
        </section>
        <section class="output_box">
            <textarea id="new_side" ></textarea>
        </section>
    </article>
</body>
</html>